{% extends "base.html" %}
{% block title %}分析 — Research Intelligence{% endblock %}
{% block content %}
<h1>分析</h1>

<h2>クラスタ概要</h2>
{% if cluster_data and cluster_data.clusters %}
<p class="meta">{{ cluster_data.total_items }} 件を {{ cluster_data.n_clusters }} クラスタに分類</p>
{% for c in cluster_data.clusters %}
<div class="card" style="margin-bottom:1rem;">
    <h3>クラスタ {{ c.id }}（{{ c.size }} 件）</h3>
    <p><strong>トピック:</strong>
    {% for t in c.top_terms[:5] %}
        <span class="badge" style="margin:0.15rem;">{{ t }}</span>
    {% endfor %}
    </p>
    <p><strong>代表的な論文:</strong></p>
    <ul>
    {% for item in c.representative_items[:3] %}
        <li><a href="/item/{{ item.id }}">{{ item.title }}</a>
            {% if item.year %}<span class="meta">[{{ item.year }}]</span>{% endif %}
            {% if item.venue %}<span class="meta">({{ item.venue }})</span>{% endif %}
        </li>
    {% endfor %}
    </ul>
</div>
{% endfor %}
{% else %}
<p class="meta">クラスタリングに十分なデータがありません。</p>
{% endif %}

<h2>影響力のある論文（引用ネットワーク）</h2>
{% if network_data and network_data.node_count > 0 %}
<p class="meta">{{ network_data.node_count }} ノード、{{ network_data.edge_count }} エッジ</p>

<h3>被引用数ランキング</h3>
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">論文</th>
        <th style="text-align:right; padding:0.5rem;">被引用数</th>
    </tr>
    {% for item in network_data.top_in_degree[:10] %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;"><a href="/item/{{ item.id }}">{{ item.title[:80] }}</a>
            {% if item.year %}<span class="meta">[{{ item.year }}]</span>{% endif %}
        </td>
        <td style="text-align:right; padding:0.5rem;">{{ item.in_degree }}</td>
    </tr>
    {% endfor %}
</table>

{% if network_data.top_pagerank %}
<h3>PageRank ランキング</h3>
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">論文</th>
        <th style="text-align:right; padding:0.5rem;">PageRank</th>
    </tr>
    {% for item in network_data.top_pagerank[:10] %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;"><a href="/item/{{ item.id }}">{{ item.title[:80] }}</a></td>
        <td style="text-align:right; padding:0.5rem;">{{ "%.4f"|format(item.pagerank) }}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if network_data.communities %}
<h3>コミュニティ（{{ network_data.community_count }} 件検出）</h3>
{% for comm in network_data.communities[:5] %}
<div class="card" style="margin-bottom:0.5rem;">
    <strong>コミュニティ {{ comm.id }}</strong>（{{ comm.size }} 件）
    <ul>
    {% for m in comm.top_members[:3] %}
        <li><a href="/item/{{ m.id }}">{{ m.title[:70] }}</a> <span class="meta">（被引用: {{ m.in_degree }}）</span></li>
    {% endfor %}
    </ul>
</div>
{% endfor %}
{% endif %}

{% else %}
<p class="meta">引用データがありません。</p>
{% endif %}

<h2>年 × 会場</h2>
{% if data.year_venue %}
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">年</th>
        <th style="text-align:left; padding:0.5rem;">会場</th>
        <th style="text-align:right; padding:0.5rem;">件数</th>
    </tr>
    {% for row in data.year_venue %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;">{{ row.year }}</td>
        <td style="padding:0.5rem;">{{ row.venue }}</td>
        <td style="text-align:right; padding:0.5rem;">{{ row.count }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p class="meta">データがありません。</p>
{% endif %}

<h2>年 × コレクション</h2>
{% if data.year_collection %}
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">年</th>
        <th style="text-align:left; padding:0.5rem;">コレクション</th>
        <th style="text-align:right; padding:0.5rem;">件数</th>
    </tr>
    {% for row in data.year_collection %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;">{{ row.year }}</td>
        <td style="padding:0.5rem;">{{ row.collection }}</td>
        <td style="text-align:right; padding:0.5rem;">{{ row.count }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p class="meta">データがありません。</p>
{% endif %}

<h2>年 × タグ</h2>
{% if data.year_tag %}
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">年</th>
        <th style="text-align:left; padding:0.5rem;">タグ</th>
        <th style="text-align:right; padding:0.5rem;">件数</th>
    </tr>
    {% for row in data.year_tag %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;">{{ row.year }}</td>
        <td style="padding:0.5rem;">{{ row.tag }}</td>
        <td style="text-align:right; padding:0.5rem;">{{ row.count }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p class="meta">データがありません。</p>
{% endif %}

<h2>Watch コレクション成長</h2>
{% if data.watch_growth %}
<table class="card" style="width:100%; border-collapse:collapse;">
    <tr style="border-bottom:1px solid var(--border);">
        <th style="text-align:left; padding:0.5rem;">コレクション</th>
        <th style="text-align:left; padding:0.5rem;">日付</th>
        <th style="text-align:right; padding:0.5rem;">累計</th>
    </tr>
    {% for row in data.watch_growth %}
    <tr style="border-bottom:1px solid var(--border);">
        <td style="padding:0.5rem;">{{ row.collection }}</td>
        <td style="padding:0.5rem;">{{ row.date }}</td>
        <td style="text-align:right; padding:0.5rem;">{{ row.cumulative_count }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p class="meta">Watch コレクションがまだありません。</p>
{% endif %}

<h2>年別キーフレーズ</h2>
{% if data.keyphrases %}
{% set ns = namespace(current_year=0) %}
{% for row in data.keyphrases %}
    {% if row.year != ns.current_year %}
        {% if ns.current_year != 0 %}</div>{% endif %}
        {% set ns.current_year = row.year %}
        <h3>{{ row.year }}</h3>
        <div class="card">
    {% endif %}
    <span class="badge" style="margin:0.15rem;">{{ row.phrase }} ({{ row.score }})</span>
{% endfor %}
{% if data.keyphrases %}</div>{% endif %}
{% else %}
<p class="meta">キーフレーズ抽出に十分なデータがありません（年あたり2件以上必要）。</p>
{% endif %}

{% endblock %}
