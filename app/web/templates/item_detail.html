{% extends "base.html" %}
{% block title %}{{ item.title }} — Research Intelligence{% endblock %}
{% block content %}
<div style="margin-bottom: 0.5rem;">
    <a href="/search">&larr; 検索に戻る</a>
</div>

<h1>{{ item.title }}</h1>

<div class="meta" style="margin-bottom: 1rem;">
    <strong>著者:</strong> {{ item.author_names | join(', ') or '不明' }}<br>
    <strong>年:</strong> {{ item.year or '?' }}
    &middot; <strong>Venue:</strong> {{ item.venue_instance or item.venue or '—' }}
    &middot; <strong>種別:</strong> <span class="badge">{{ item.type }}</span>
    &middot; <strong>BibTeX Key:</strong> <code>{{ item.bibtex_key or '—' }}</code>
</div>

{% if item.source_url or item.pdf_path %}
<div style="margin-bottom: 1rem;">
    {% if item.source_url %}
    <a href="{{ item.source_url }}" target="_blank" class="btn btn-secondary">原文リンク</a>
    {% endif %}
    {% if item.pdf_path %}
    <a href="/item/{{ item.id }}/pdf" target="_blank" class="btn btn-secondary" style="margin-left: 0.5rem;">PDF を開く</a>
    {% elif item.source_url %}
    <button id="btn-download-extract" onclick="downloadAndExtract()" class="btn btn-secondary" style="margin-left: 0.5rem;">PDF取得＆引用抽出</button>
    <span id="download-status" style="margin-left: 0.5rem;"></span>
    {% endif %}
</div>
<script>
function downloadAndExtract() {
    var btn = document.getElementById('btn-download-extract');
    var status = document.getElementById('download-status');
    btn.disabled = true;
    btn.textContent = '処理中...';
    status.textContent = '';

    fetch('/api/item/{{ item.id }}/download-and-extract', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var steps = data.steps || {};
            var msgs = [];
            if (steps.download) msgs.push('PDF: ' + (steps.download.ok ? (steps.download.downloaded ? 'ダウンロード済み' : 'スキップ') : 'エラー'));
            if (steps.extract_text) msgs.push('テキスト: ' + (steps.extract_text.ok ? (steps.extract_text.extracted ? '抽出済み' : 'スキップ') : 'エラー'));
            if (steps.extract_references) msgs.push('参照: ' + (steps.extract_references.ok ? steps.extract_references.count + '件' : 'エラー'));
            if (steps.resolve) msgs.push('解決: ' + (steps.resolve.ok ? steps.resolve.resolved + '件' : 'エラー'));
            status.textContent = msgs.join(' | ');
            btn.textContent = '完了';
            setTimeout(function() { location.reload(); }, 2000);
        })
        .catch(function(e) {
            status.textContent = 'エラー: ' + e;
            btn.disabled = false;
            btn.textContent = 'PDF取得＆引用抽出';
        });
}
</script>
{% endif %}

<div class="card" style="margin-bottom: 1rem;">
    <h2 style="margin-top: 0;">タグ</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.5rem;">
    {% for tag in tags %}
        <span class="badge" style="display: inline-flex; align-items: center; gap: 0.3rem;">
            {{ tag }}
            <form action="/item/{{ item.id }}/tag/{{ tag }}/delete" method="post" style="display:inline; margin:0;">
                <button type="submit" style="background:none; border:none; cursor:pointer; padding:0; font-size:0.9em;" title="削除">&times;</button>
            </form>
        </span>
    {% endfor %}
    {% if not tags %}
        <span style="color: #888;">(タグなし)</span>
    {% endif %}
    </div>
    <form action="/item/{{ item.id }}/tag" method="post" style="display: flex; gap: 0.5rem;">
        <input type="text" name="tag_name" placeholder="タグを追加 (例: method/RAG)" style="flex: 1; padding: 0.3rem;">
        <button type="submit">追加</button>
    </form>
</div>

{% if item.abstract %}
<h2>Abstract</h2>
<div class="abstract">{{ item.abstract }}</div>
{% endif %}

{% if item.bibtex_raw %}
<h2>BibTeX</h2>
<div style="position:relative;">
    <button onclick="copyBibtex()" style="position:absolute; top:0.3rem; right:0.3rem; font-size:0.75rem; padding:0.2rem 0.5rem;" title="コピー">コピー</button>
    <pre id="bibtex-raw">{{ item.bibtex_raw }}</pre>
</div>
<script>
function copyBibtex() {
    var text = document.getElementById('bibtex-raw').innerText;
    navigator.clipboard.writeText(text).then(function() {
        var btn = event.target;
        btn.textContent = 'コピー済み';
        setTimeout(function() { btn.textContent = 'コピー'; }, 2000);
    });
}
</script>
{% endif %}

<h2>ノート</h2>
{% for note in notes %}
<div class="card">
    <h3>{{ note.title }}</h3>
    <form action="/item/{{ item.id }}/note/{{ note.id }}/save" method="post">
        <textarea name="content">{{ note_contents.get(note.id, '') }}</textarea>
        <div style="margin-top: 0.5rem;">
            <button type="submit">保存</button>
        </div>
    </form>
</div>
{% endfor %}

{% if graph %}
<h2>引用関係</h2>
<div class="card" style="margin-bottom: 1rem;">
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button onclick="showTab('refs')" id="tab-refs" style="font-weight:bold; border-bottom: 2px solid #007bff;">References</button>
        <button onclick="showTab('citedby')" id="tab-citedby">Cited by</button>
        <button onclick="showTab('similar')" id="tab-similar">Similar</button>
        <button onclick="showTab('mentions')" id="tab-mentions">Mentioned in Notes</button>
        <button onclick="showTab('graph')" id="tab-graph">Graph</button>
    </div>

    <div id="panel-refs">
        {% if graph.cites %}
        <h3>この論文が引用 ({{ graph.cites|length }}件)</h3>
        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <thead>
                <tr style="border-bottom:2px solid #ddd;">
                    <th style="text-align:left; padding:0.3rem;">タイトル</th>
                    <th style="text-align:left; padding:0.3rem; width:60px;">年</th>
                </tr>
            </thead>
            <tbody>
            {% for c in graph.cites %}
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:0.3rem;"><a href="/item/{{ c.id }}">{{ c.title }}</a></td>
                    <td style="padding:0.3rem;">{{ c.year or '?' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="meta">解決済み引用なし</p>
        {% endif %}

        {% if graph.unresolved_refs %}
        <h3 style="margin-top:1rem;">未解決の参照 ({{ graph.unresolved_refs|length }}件)</h3>
        <ul style="font-size:0.85em; color:#666;">
        {% for ref in graph.unresolved_refs[:20] %}
            <li style="margin-bottom:0.5rem;">
                {{ ref.raw_cite }}{% if ref.dst_key %} <code>[{{ ref.dst_key }}]</code>{% endif %}
                {% if ref.citation_id %}
                <form action="/api/citation/{{ ref.citation_id }}/resolve" method="post" style="display:inline; margin-left:0.5rem;">
                    <input type="number" name="target_item_id" placeholder="Item ID" style="width:80px; font-size:0.8em; padding:0.1rem;">
                    <button type="submit" style="font-size:0.75em; padding:0.1rem 0.4rem;">解決</button>
                </form>
                {% endif %}
            </li>
        {% endfor %}
        {% if graph.unresolved_refs|length > 20 %}
            <li>... 他 {{ graph.unresolved_refs|length - 20 }}件</li>
        {% endif %}
        </ul>
        {% endif %}
    </div>

    <div id="panel-citedby" style="display:none;">
        {% if graph.cited_by %}
        <h3>この論文を引用 ({{ graph.cited_by|length }}件)</h3>
        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <thead>
                <tr style="border-bottom:2px solid #ddd;">
                    <th style="text-align:left; padding:0.3rem;">タイトル</th>
                    <th style="text-align:left; padding:0.3rem; width:60px;">年</th>
                </tr>
            </thead>
            <tbody>
            {% for c in graph.cited_by %}
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:0.3rem;"><a href="/item/{{ c.id }}">{{ c.title }}</a></td>
                    <td style="padding:0.3rem;">{{ c.year or '?' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="meta">被引用なし</p>
        {% endif %}
    </div>

    <div id="panel-similar" style="display:none;">
        <h3>類似論文</h3>
        <div id="similar-list"><p class="meta">読み込み中...</p></div>
        <script>
        (function() {
            fetch('/api/item/{{ item.id }}/similar')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var el = document.getElementById('similar-list');
                    if (!data || data.length === 0) {
                        el.innerHTML = '<p class="meta">類似論文なし</p>';
                        return;
                    }
                    var html = '<table style="width:100%; border-collapse:collapse; font-size:0.9em;">';
                    html += '<thead><tr style="border-bottom:2px solid #ddd;"><th style="text-align:left; padding:0.3rem;">タイトル</th><th style="padding:0.3rem; width:60px;">年</th><th style="padding:0.3rem; width:60px;">類似度</th></tr></thead><tbody>';
                    data.forEach(function(d) {
                        html += '<tr style="border-bottom:1px solid #eee;"><td style="padding:0.3rem;"><a href="/item/' + d.id + '">' + d.title + '</a></td><td style="padding:0.3rem;">' + (d.year || '?') + '</td><td style="padding:0.3rem;">' + d.score + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    el.innerHTML = html;
                })
                .catch(function() {
                    document.getElementById('similar-list').innerHTML = '<p class="meta">読み込みに失敗しました</p>';
                });
        })();
        </script>
    </div>

    <div id="panel-mentions" style="display:none;">
        <h3>ノートで言及</h3>
        <div id="mentions-list"><p class="meta">読み込み中...</p></div>
        <script>
        (function() {
            fetch('/api/item/{{ item.id }}/mentioned-in-notes')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var el = document.getElementById('mentions-list');
                    if (!data || data.length === 0) {
                        el.innerHTML = '<p class="meta">ノートでの言及なし</p>';
                        return;
                    }
                    var html = '<ul>';
                    data.forEach(function(d) {
                        html += '<li><a href="/item/' + d.id + '">' + d.title + '</a> (' + (d.year || '?') + ')</li>';
                    });
                    html += '</ul>';
                    el.innerHTML = html;
                })
                .catch(function() {
                    document.getElementById('mentions-list').innerHTML = '<p class="meta">読み込みに失敗しました</p>';
                });
        })();
        </script>
    </div>

    <div id="panel-graph" style="display:none;">
        <a href="/graph/{{ item.id }}" class="btn btn-secondary">グラフを表示</a>
        <a href="/graph/{{ item.id }}?depth=2" class="btn btn-secondary">2ホップグラフ</a>
    </div>
</div>

<script>
function showTab(name) {
    ['refs', 'citedby', 'similar', 'mentions', 'graph'].forEach(function(t) {
        document.getElementById('panel-' + t).style.display = t === name ? 'block' : 'none';
        var tab = document.getElementById('tab-' + t);
        tab.style.fontWeight = t === name ? 'bold' : 'normal';
        tab.style.borderBottom = t === name ? '2px solid #007bff' : 'none';
    });
}
</script>
{% endif %}

{% if matched_chunks %}
<h2>マッチしたチャンク</h2>
<div class="card">
{% for mc in matched_chunks %}
    <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-left: 3px solid #007bff;">
        <span class="badge" style="font-size: 0.75em;">{{ "%.3f"|format(mc.score) }}</span>
        <span style="font-size: 0.8em; color: #888;">[chars {{ mc.start_char }}-{{ mc.end_char }}]</span>
        <div style="margin-top: 0.3rem; font-size: 0.9em;">{{ mc.text }}</div>
    </div>
{% endfor %}
</div>
{% endif %}
{% endblock %}
